#!/bin/bash
set -o pipefail
cairo-watch-header

# Function to execute commands and handle errors
execute_command() {
	local command="$1"
	local output
	output=$(eval "$command" 2>&1)
	status=$?
	if [ $status -ne 0 ]; then
		# Need to see all errors
		echo -e "\033[31mTESTING ERROR\033[0m"
		# Only which tests failed
		echo "$output" | awk '/failures:/,/make: \*\*\* .* Error/'
		exit 1
	else
		# Command exited successfully
		echo -e "\033[32mALL TEST PASS\033[0m"
		# echo "$output"
	fi
}

if [ $# -eq 0 ]; then
	command="make"
else
	ARGS="$@"
	command="make test_with_args ARGS=\"$ARGS\""
fi

# Execute command
# execute_command "make compile"

output=$(eval "make compile" 2>&1)
status=$?
if [ $status -ne 0 ]; then
	# I dont want to see all errors
	echo -e "\033[31mCOMPILATION ERROR\033[0m"
	echo "$output" | head -n 15
	exit 1
else
	# Command exited successfully
	echo -e "\033[32mCOMPILATION OK\033[0m"
	# echo "$output"
fi
execute_command "$command"
